# üß† VM Escape Through NFC

> –ê–ø–ø–∞—Ä–∞—Ç–Ω–æ-–ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ–µ CTF-–∑–∞–¥–∞–Ω–∏–µ: –≤–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è –º–∞—à–∏–Ω–∞, NFC, Rust, reverse engineering, —Ñ–ª–∞–≥.

---

## üì¶ –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞

–≠—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç ‚Äî —Å—Ç–µ–Ω–¥ CTF —Å —Ä–µ–∞–ª—å–Ω—ã–º –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ–º, –Ω–∞–ø–∏—Å–∞–Ω–Ω—ã–π –Ω–∞ —á–∏—Å—Ç–æ–º Rust –∏ Go, –≥–¥–µ —É—á–∞—Å—Ç–Ω–∏–∫ –¥–æ–ª–∂–µ–Ω:

- üì≤ —á–µ—Ä–µ–∑ NFC –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π payload –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ,
- üîê –ø—Ä–æ–π—Ç–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏: `XOR`, `CRC32`, `tag`,
- üß† –ø–µ—Ä–µ–¥–∞—Ç—å –∫–æ–º–∞–Ω–¥—É –≤ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—É—é –º–∞—à–∏–Ω—É (VM),
- üö™ –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Ü–µ–ø–æ—á–∫—É –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π (`MOV`, `ADD`, `JEQ`, `CALL`),
- ‚úÖ –≤—ã–∑–≤–∞—Ç—å —Å–∫—Ä—ã—Ç—É—é —Ñ—É–Ω–∫—Ü–∏—é `send_flag()`,
- üì° –æ—Ç–ø—Ä–∞–≤–∏—Ç—å HTTP POST-–∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Ñ–ª–∞–≥.

---

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è

```text
vm-escape-nfc/
‚îÇ
‚îú‚îÄ‚îÄ builder/               # üîß build_payload.rs ‚Äì –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∫–æ–¥–∞ VM ‚Üí –±–∞–π—Ç—ã
‚îÇ
‚îú‚îÄ‚îÄ griph/         # üß† –ë–∏–Ω–∞—Ä—å –Ω–∞ —Å—Ç–µ–Ω–¥–µ: VM, –ø—Ä–æ–≤–µ—Ä–∫–∞, —Ñ–ª–∞–≥
‚îÇ   ‚îî‚îÄ‚îÄ src/
‚îÇ       ‚îî‚îÄ‚îÄ vm.rs          # –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω—ã
‚îÇ
‚îú‚îÄ‚îÄ nfc_reader/            # üì° –ß—Ç–µ–Ω–∏–µ NFC (Rust-only, —á–µ—Ä–µ–∑ SPI)
‚îÇ
‚îú‚îÄ‚îÄ backend/               # üåê Go-—Å–µ—Ä–≤–µ—Ä, –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ñ–ª–∞–≥
‚îÇ
‚îú‚îÄ‚îÄ system/                # ‚öô –°–µ—Ä–≤–∏—Å—ã systemd, –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫
‚îÇ
‚îú‚îÄ‚îÄ payloads/              # üìÇ –ü—Ä–∏–º–µ—Ä—ã payload-–æ–≤ –∏ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞
‚îÇ
‚îî‚îÄ‚îÄ docs/                  # üìö –ê–ø–ø–∞—Ä–∞—Ç–Ω–∞—è —Å—Ö–µ–º–∞, Reverse writeup –∏ –æ–ø–∏—Å–∞–Ω–∏–µ —É—Ä–æ–≤–Ω–µ–π
```

---

## üõ† –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç       | –í–µ—Ä—Å–∏—è –∏–ª–∏ –∞–Ω–∞–ª–æ–≥ |
|------------------|-------------------|
| ‚úÖ Rust          | 1.70+             |
| ‚úÖ Cargo         | –¥–∞                |
| ‚úÖ Orange Pi 5   | –ª–∏–±–æ Pi 4         |
| ‚úÖ –ú–æ–¥—É–ª—å NFC    | PN532 –ø–æ SPI      |
| ‚úÖ NFC –º–µ—Ç–∫–∏     | NTAG213/215       |
| ‚úÖ Linux         | Ubuntu / Armbian  |
| Go (–±—ç–∫–µ–Ω–¥)      | 1.23+             |

---

## üîß –£—Å—Ç–∞–Ω–æ–≤–∫–∞

### Rust –æ–∫—Ä—É–∂–µ–Ω–∏–µ:

```bash
rustup default stable
```

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π:

```bash
sudo apt update
sudo apt install libudev-dev spidev libssl-dev
```

---

## üñ• –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ PN532 –∫ Orange Pi 5

| PN532        | Orange Pi PIN |
|--------------|----------------|
| VCC          | 5V (PIN 2)     |
| GND          | GND (PIN 6)    |
| SCK          | PIN 23 (SPI0_CLK)   |
| MISO         | PIN 21 (SPI0_MISO)  |
| MOSI         | PIN 19 (SPI0_MOSI)  |
| SS (CS)      | PIN 24 (SPI0_CS0)   |

‚úÖ SPI –≤–∫–ª—é—á–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `armbian-config`

---

## üöÄ –ó–∞–ø—É—Å–∫ —Å—Ç–µ–Ω–¥–∞

```bash
# –°–æ–±—Ä–∞—Ç—å –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å NFC —Ä–∏–¥–µ—Ä
cd nfc_reader
cargo build --release
./target/release/nfc_reader
```

```bash
# –°–æ–±—Ä–∞—Ç—å –∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å VM
cd griph
cargo build --release
./target/release/griph
```

–°—Ç–∞—Ä—Ç–æ–≤—ã–π payload –º–æ–∂–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å:

```bash
cd builder
cargo run --release -- \
  build-sequence \
  --sequence "MOV 0 41 ADD 0 1 JEQ 0 42 3 CALL 4195636"
```

---

## üß† –í–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è –º–∞—à–∏–Ω–∞

| –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è | –û–ø–∏—Å–∞–Ω–∏–µ                                |
|------------|-----------------------------------------|
| `MOV`      | –ó–∞–ø–∏—Å–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –≤ —Ä–µ–≥–∏—Å—Ç—Ä             |
| `ADD`      | –ü—Ä–∏–±–∞–≤–∏—Ç—å –∫ —Ä–µ–≥–∏—Å—Ç—Ä—É                    |
| `JEQ`      | –£—Å–ª–æ–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥                        |
| `CALL`     | –í—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ –∞–¥—Ä–µ—Å—É (unsafe)        |
| `NOP`      | –ù–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ—Ç                        |

–ü—Ä–∏–º–µ—Ä:
```
MOV R0, 41
ADD R0, 1
JEQ R0, 42, 3
CALL 0x401234
```

---

## üìÑ Payload —Ñ–æ—Ä–º–∞—Ç

```text
[ 0x03 ][ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–∞—è VM-–ø—Ä–æ–≥—Ä–∞–º–º–∞ ][ CRC32 ]
                  ^ XOR —Å –∫–ª—é—á–æ–º 0x5A
```

- –ú–∏–Ω–∏–º—É–º –¥–ª–∏–Ω—ã: ~10 –±–∞–π—Ç
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ `griph`
- –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ Android (NFC Tools ‚Üí MIME)

---

## üßä –ó–∞—â–∏—Ç–∞

- ‚úÖ tag check (0x03)
- ‚úÖ CRC32 —Ö–µ—à
- ‚úÖ XOR
- ‚úÖ VM —Å opcode-–º–∞—à–∏–Ω–æ–π
- ‚úÖ `#[no_mangle]` –Ω–∞ `send_flag()` ‚Äî –æ—Ç–∫—Ä—ã—Ç–∞ —Ç–æ–ª—å–∫–æ –ø–æ –∞–¥—Ä–µ—Å—É
- ‚úÖ Unsafe `fn()` –≤—ã–∑–æ–≤: –∫–∞–∫ ROP-lite

---

## üîê –ü–æ–ª—É—á–µ–Ω–∏–µ —Ñ–ª–∞–≥–∞

–ï—Å–ª–∏ –≤—ã–∑–æ–≤ `send_flag()` –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ, –æ–Ω –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç:

```json
POST /flag
{ "token": "CTF{super_ctf_mastermind}" }
```

–û—Ç–≤–µ—Ç:
```json
{ "flag": "CTF{you_did_it}" }
```

---

## üì± Android-–ø–æ–¥–¥–µ—Ä–∂–∫–∞

- NFC Tools (Android/iOS)
- ‚Üí –ó–∞–ø–∏—Å—å : [Custom MIME-type : `application/x-ctf`]
- ‚Üí Payload = –≤–∞—à —Å–æ–±—Ä–∞–Ω–Ω—ã–π `rfid_input.bin`

---

## üìÇ –ü—Ä–∏–º–µ—Ä—ã

```bash
cat payloads/example_1_desc.txt
> MOV R0, 41 + ADD 1 + JEQ 42 + CALL send_flag

xxd payloads/example_1.bin
> 03 b4 9a 1e 4f ... (XOR + CRC)
```

---

## üìã –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

```bash
nfc-list                  # –ø—Ä–æ–≤–µ—Ä–∫–∏ PN532
cat /tmp/rfid_input.bin   # –ø—Ä–æ–≤–µ—Ä–∫–∞ payload
nm target/release/vm      # –ø–æ–∏—Å–∫ –∞–¥—Ä–µ—Å–∞ send_flag
```

---

## üìê Roadmap

- [x] –ß–∏—Å—Ç—ã–π Rust NFC reader —á–µ—Ä–µ–∑ SPI
- [x] Payload builder –Ω–∞ Rust (–±–µ–∑ Python)
- [x] Unsafe CALL ‚Üí —Ñ–ª–∞–≥
- [x] Payload: tag + xor + crc
- [ ] HTML-–¥–µ–∫–æ–¥–µ—Ä + write-–ø—Ä–∏–º–µ—Ä
- [ ] Web-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ payload
- [ ] –û–±—Ä–∞—Ç–Ω—ã–π –¥–∏–∑–∞—Å—Å–µ–º–±–ª–µ—Ä –Ω–∞ Rust
- [ ] –ú—É–ª—å—Ç–∏–∫–∞—Ä—Ç–Ω–∞—è VM (UID)

---

## üßë‚Äçüíª –ê–≤—Ç–æ—Ä—ã

**hRAZ**
Reverse –∏–Ω–∂–µ–Ω–µ—Ä & Rust-—Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ —É—Ä–æ–≤–Ω—è CTF-–∞—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä–∞
–ö–æ–Ω—Ç–∞–∫—Ç—ã: [—Å–∫—Ä—ã—Ç—ã –¥–ª—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è] üòâ

**p1zza**

---

## üí° –ë–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏
- –í—Å–µ–ª–µ–Ω–Ω–∞—è, Rust –∏ Coffee
